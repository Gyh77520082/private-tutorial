user www www;
worker_processes auto;

error_log     /var/log/nginx/error.log;
pid           /var/run/nginx.pid;

worker_rlimit_nofile 65535;

events {
    worker_connections  65535;
    use epoll;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
            '$status $body_bytes_sent "$http_referer" $request_time '
            '"$http_user_agent" "$http_x_forwarded_for"';

    log_format proxy '$http_x_forwarded_for - $remote_user [$time_local] "$request" '
            '$status $body_bytes_sent "$http_referer" $request_time '
            '"$http_user_agent"';

    log_format fastcgi '$remote_addr - $remote_user [$time_local] "$request" '
            '$status $body_bytes_sent "$http_referer" '
            '$upstream_http_content_type $upstream_response_time $msec $request_time';

    log_format json '{"@timestamp":"$time_iso8601",'
            '"@version":"1",'
            '"server_addr":"$server_addr",'
            '"remote_addr":"$remote_addr",'
            '"host":"$host",'
            '"uri":"$uri",'
            '"body_bytes_sent":$body_bytes_sent,'
            '"bytes_sent":$body_bytes_sent,'
            '"upstream_response_time":$upstream_response_time,'
            '"request":"$request",'
            '"request_length":$request_length,'
            '"request_time":$request_time,'
            '"status":"$status",'
            '"http_referer":"$http_referer",'
            '"http_x_forwarded_for":"$http_x_forwarded_for",'
            '"http_user_agent":"$http_user_agent"'
            '}';

    access_log /var/log/nginx/access.log main;

    server_tokens off;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options: "nosniff";
    add_header X-XSS-Protection: "1; mode=block";
    add_header Content-Security-Policy: "default-src 'self'";
    add_header Set-Cookie "HttpOnly; Secure";

    ssl_protocols      TLSv1.2 TLSv1.3;
    ssl_ciphers        ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305;

    client_max_body_size   100m;
    client_body_temp_path  "/tmp/client_body" 1 2;

    sendfile           on;
    tcp_nopush         on;
    tcp_nodelay        off;

    keepalive_timeout  65;
    keepalive_disable  none;
    keepalive_requests 100;

    # fastcgi
    fastcgi_connect_timeout      300;
    fastcgi_send_timeout         300;
    fastcgi_read_timeout         300;
    fastcgi_buffer_size          64k;
    fastcgi_buffers              4 64k;
    fastcgi_busy_buffers_size    128k;
    fastcgi_temp_file_write_size 128k;
    fastcgi_temp_path            "/tmp/fastcgi" 1 2;

    # scgi
    scgi_temp_path         "/tmp/scgi" 1 2;

    # uwscgi
    uwsgi_temp_path        "/tmp/uwsgi" 1 2;

    # Compress
    gzip on;
    gzip_http_version 1.0;
    gzip_comp_level 2;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_types text/plain text/css text/xml application/javascript application/xml+rss;
    gzip_vary on;

    # Proxy
    proxy_connect_timeout      600;
    proxy_read_timeout         600;
    proxy_send_timeout         600;
    proxy_buffer_size          64k;
    proxy_buffers 4            32k;
    proxy_busy_buffers_size    64k;
    proxy_temp_file_write_size 64k;
    proxy_temp_path            "/tmp/proxy" 1 2;

    # exclude config directory
    include /etc/nginx/http.d/*.conf;
}

stream {
    include /etc/nginx/stream.d/*.conf;
}